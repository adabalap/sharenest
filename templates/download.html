{% extends "layout.html" %}

{% block meta_tags %}
    {% set og_image_url = config['APP_HOST'] + url_for('static', filename='images/mobile_icon_512x512.png', _external=True) %}
    <meta property="og:title" content="You've received '{{ file_info.original_filename if file_info else 'a file' }}' via ShareNest">
    <meta property="og:description" content="{{ sharing_message if sharing_message else 'Click to securely download your file.' }}">
    <meta property="og:image" content="{{ og_image_url }}">
    <meta property="og:image:width" content="512">
    <meta property="og:image:height" content="512">
    <meta property="og:url" content="{{ request.url }}">
    <meta property="og:type" content="website">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="You've received '{{ file_info.original_filename if file_info else 'a file' }}' via ShareNest">
    <meta name="twitter:description" content="{{ sharing_message if sharing_message else 'Click to securely download your file.' }}">
    <meta name="twitter:image" content="{{ og_image_url }}">
{% endblock %}

{% block content %}
<div class="card">
  <h2>Access Your File</h2>
  {% if file_info and not expired and not limit_reached %}
    <p>Enter the phrase to download <strong>{{ file_info.original_filename }}</strong>.</p>
    {% if sharing_message %}
        <div class="alert alert-info mt-3">
            <strong>Message from sender:</strong><br>
            {{ sharing_message }}
        </div>
    {% endif %}
  {% elif expired or limit_reached %}
    <p>This link is no longer available.</p>
  {% else %}
    <p>This link could not be found.</p>
  {% endif %}

  {% if expired or limit_reached %}
    <div class="centered-message">
      <h3>Link Expired</h3>
      <p>This file is no longer available for download.</p>
      <a href="{{ url_for('home') }}" class="btn btn-primary">Share Another File</a>
    </div>
  {% elif file_info %}
    <div class="file-info">
      <div>
        <dt>Downloads Left</dt>
        <dd>{{ file_info.max_downloads - file_info.download_count }}</dd>
      </div>
      <div>
        <dt>Expires in</dt>
        <dd>{{ expiry_pretty }}</dd>
      </div>
    </div>
    <form action="{{ url_for('download_after_pin', token=token) }}" method="post" class="mt-3">
      <div class="form-group mb-3">
        <label for="security_phrase" class="form-label">Security Phrase</label>
        <input type="password" name="security_phrase" id="security_phrase" class="form-control" required>
      </div>
      <button type="submit" class="btn btn-primary w-100">Unlock & Download</button>
    </form>

    <div class="share-options mt-4">
        <h4 class="text-center">Share this link</h4>
        <div class="share-buttons">
            <a href="https://api.whatsapp.com/send?text={{ (sharing_message + ' ' if sharing_message else '') ~ request.url }}" target="_blank" class="share-btn whatsapp">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">...</svg>
                <span>WhatsApp</span>
            </a>
            <a href="mailto:?subject=File received via ShareNest&body={{ (sharing_message + '%0A%0A' if sharing_message else '') ~ 'You can download the file here: ' ~ request.url }}" class="share-btn email">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">...</svg>
                <span>Email</span>
            </a>
        </div>
    </div>

  {% else %}
      <div class="centered-message">
          <h3>Not Found</h3>
          <p>The requested file could not be found.</p>
      </div>
  {% endif %}
</div>
{% endblock %}
