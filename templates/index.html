{% extends "layout.html" %}
{% block content %}
<div class="card">
  <h2 id="card-title">Share a File</h2>
  <p id="card-subtitle">Upload a file, get a secure link.</p>

  <div id="form-view">
    <form id="upload-form">
      <div class="form-group">
        <div id="file-drop-zone">
          <p id="file-name-display">Drop a file here or click to select</p>
          <input id="file-upload" name="file" type="file" required>
        </div>
      </div>
      <div class="form-group">
        <label for="security_phrase">Security Phrase</label>
        <input type="password" name="security_phrase" id="security_phrase" minlength="4" required placeholder="At least 4 characters">
      </div>
      <div class="form-group">
        <button type="submit" class="btn btn-primary">Create Secure Link</button>
      </div>
    </form>
  </div>

  <div id="progress-view" class="hidden">
      <div id="progress-filename"></div>
      <div id="progress-percent">0%</div>
      <div class="progress-bar-container">
          <div id="progress-bar" style="width: 0%"></div>
      </div>
      <div id="progress-status"></div>
  </div>

  <div id="result-view" class="hidden"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('upload-form');
    const fileInput = document.getElementById('file-upload');
    const fileNameDisplay = document.getElementById('file-name-display');
    const dropZone = document.getElementById('file-drop-zone');
    const submitButton = form.querySelector('button[type="submit"]');

    const cardTitle = document.getElementById('card-title');
    const cardSubtitle = document.getElementById('card-subtitle');
    
    const formView = document.getElementById('form-view');
    const progressView = document.getElementById('progress-view');
    const resultView = document.getElementById('result-view');

    const progressFileName = document.getElementById('progress-filename');
    const progressPercent = document.getElementById('progress-percent');
    const progressBar = document.getElementById('progress-bar');
    const progressStatus = document.getElementById('progress-status');

    function switchView(view) {
        formView.classList.add('hidden');
        progressView.classList.add('hidden');
        resultView.classList.add('hidden');
        if (view === 'form') {
            formView.classList.remove('hidden');
            cardTitle.textContent = 'Share a File';
            cardSubtitle.textContent = 'Upload a file, get a secure link.';
        } else if (view === 'progress') {
            progressView.classList.remove('hidden');
            cardTitle.textContent = 'Uploading...';
        } else if (view === 'result') {
            resultView.classList.remove('hidden');
            cardTitle.textContent = 'Link Created!';
            cardSubtitle.textContent = 'Your secure link is ready to be shared.';
        }
    }

    function handleFileSelect(files) {
        if (files.length > 0) {
            const file = files[0];
            fileInput.files = files;
            fileNameDisplay.textContent = `${file.name} (${formatBytes(file.size)})`;
        }
    }

    fileInput.addEventListener('change', () => handleFileSelect(fileInput.files));
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleFileSelect(e.dataTransfer.files);
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const file = fileInput.files[0];
        const pin = document.getElementById('security_phrase').value;

        if (!file) { showError('Please select a file to upload.'); return; }
        if (pin.length < 4) { showError('Security phrase must be at least 4 characters.'); return; }

        setFormDisabled(true);
        switchView('progress');
        progressFileName.textContent = file.name;
        updateProgressUI(0, file.size, 'Initializing...');

        try {
            const initResponse = await fetch('/api/initiate-upload', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: file.name, file_size_bytes: file.size }),
            });

            if (!initResponse.ok) {
                const err = await initResponse.json();
                throw new Error(err.error || 'Could not initiate upload.');
            }

            const result = await initResponse.json();
            
            if (result.upload_type === 'direct') {
                await directUpload(file, pin, result.par_url, result.object_name);
            } else if (result.upload_type === 'multipart') {
                await multipartUpload(file, pin, result);
            }

        } catch (error) {
            showError(error.message);
        }
    });

    function setFormDisabled(disabled) {
        submitButton.disabled = disabled;
        fileInput.disabled = disabled;
        document.getElementById('security_phrase').disabled = disabled;
    }

    function updateProgressUI(loaded, total, statusText) {
        const percent = total > 0 ? Math.round((loaded / total) * 100) : 0;
        progressBar.style.width = `${percent}%`;
        progressPercent.textContent = `${percent}%`;
        progressStatus.textContent = statusText;
    }

    async function directUpload(file, pin, parUrl, objectName) {
        await uploadWithXHR(parUrl, file, (loaded, total) => {
            updateProgressUI(loaded, total, `Uploading... ${formatBytes(loaded)} / ${formatBytes(total)}`);
        });
        await finalizeUpload(pin, file.name, objectName, file.size);
    }

    async function multipartUpload(file, pin, { upload_id, object_name, part_size_bytes }) {
        const totalParts = Math.ceil(file.size / part_size_bytes);
        let uploadedParts = [];
        let loadedSoFar = 0;

        for (let i = 0; i < totalParts; i++) {
            const partNum = i + 1;
            updateProgressUI(loadedSoFar, file.size, `Uploading part ${partNum} of ${totalParts}...`);
            
            const start = i * part_size_bytes;
            const end = Math.min(start + part_size_bytes, file.size);
            const chunk = file.slice(start, end);

            const partUrlResponse = await fetch('/api/request-part-url', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ object_name, upload_id, part_num: partNum }),
            });
            if (!partUrlResponse.ok) throw new Error(`Could not get URL for part ${partNum}.`);
            const { par_url } = await partUrlResponse.json();

            const etag = await uploadWithXHR(par_url, chunk, (partLoaded, partTotal) => {
                updateProgressUI(loadedSoFar + partLoaded, file.size, `Uploading part ${partNum} of ${totalParts}...`);
            });

            uploadedParts.push({ partNum, etag });
            loadedSoFar += chunk.size;
        }

        await finalizeUpload(pin, file.name, object_name, file.size, upload_id, uploadedParts);
    }

    function uploadWithXHR(url, body, onProgress) {
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            xhr.open('PUT', url, true);
            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) onProgress(e.loaded, e.total);
            };
            xhr.onload = () => {
                if (xhr.status >= 200 && xhr.status < 300) {
                    const etag = xhr.getResponseHeader('ETag');
                    resolve(etag);
                } else {
                    reject(new Error(`Upload failed with status: ${xhr.status}`));
                }
            };
            xhr.onerror = () => reject(new Error('A network error occurred during upload.'));
            xhr.send(body);
        });
    }

    async function finalizeUpload(pin, original_filename, object_name, size_bytes, upload_id = null, parts = null) {
        updateProgressUI(size_bytes, size_bytes, 'Finalizing...');
        const body = { pin, original_filename, object_name, size_bytes, upload_id, parts };
        
        const finalizeResponse = await fetch('/api/finalize-upload', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
        });

        if (!finalizeResponse.ok) {
            const err = await finalizeResponse.json();
            throw new Error(err.error || 'Could not finalize upload.');
        }

        const result = await finalizeResponse.json();
        showSuccess(result);
    }

    function showSuccess(data) {
        switchView('result');
        resultView.innerHTML = `
            <div class="share-link-wrapper">
              <p>Your file <strong class="filename">${escapeHTML(data.filename)}</strong> is ready to be shared.</p>
              <div class="share-link-container">
                <label for="share-url-input">Share Link (expires in ${data.expiry_pretty})</label>
                <div class="share-link-input-wrapper">
                  <input id="share-url-input" type="text" value="${escapeHTML(data.share_url)}" readonly>
                  <button id="copy-btn" class="btn btn-secondary">Copy</button>
                </div>
              </div>
              <button id="reset-button" class="btn btn-primary">Share Another File</button>
            </div>`;
        
        document.getElementById('copy-btn').addEventListener('click', (e) => {
            copyToClipboard(data.share_url, 'Share link copied!');
            e.target.textContent = 'Copied!';
            setTimeout(() => { e.target.textContent = 'Copy'; }, 2000);
        });
        document.getElementById('reset-button').addEventListener('click', resetToForm);
    }

    function showError(message) {
        switchView('result');
        resultView.innerHTML = `
            <div class="error-message">
              <h3>Upload Error</h3>
              <p>${escapeHTML(message)}</p>
            </div>
            <button id="reset-button" class="btn btn-primary">Try Again</button>`;
        document.getElementById('reset-button').addEventListener('click', resetToForm);
    }
    
    function resetToForm() {
        form.reset();
        fileNameDisplay.textContent = 'Drop a file here or click to select';
        setFormDisabled(false);
        switchView('form');
    }

    function formatBytes(bytes, decimals = 2) {
        if (!+bytes) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
    }

    function escapeHTML(str) {
        return str.replace(/[&<>"']/g, match => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match]));
    }
});
</script>
{% endblock %}