{% extends "layout.html" %}
{% block content %}
<div class="card">
  <h2 id="card-title">Share a File</h2>
  <p id="card-subtitle">Upload a file, get a secure link.</p>

  <div id="form-view">
    <form id="upload-form">
      <div class="form-group">
        <div id="file-drop-zone">
          <p id="file-name-display">Drop a file here or click to select</p>
          <input id="file-upload" name="file" type="file" required>
        </div>
      </div>
      <div class="form-group">
        <label for="security_phrase">Security Phrase</label>
        <input type="password" name="security_phrase" id="security_phrase" minlength="4" required placeholder="At least 4 characters">
      </div>
      <div class="form-group">
        <button type="submit" class="btn btn-primary">Create Secure Link</button>
      </div>
    </form>
  </div>

  <div id="progress-view" class="hidden">
      <div id="progress-filename"></div>
      <div id="progress-percent">0%</div>
      <div class="progress-bar-container">
          <div id="progress-bar" style="width: 0%"></div>
      </div>
      <div id="progress-status"></div>
      <div id="progress-eta"></div>
  </div>

  <div id="result-view" class="hidden"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    console.log("ShareNest script loaded. Initializing...");
    const form = document.getElementById('upload-form');
    const fileInput = document.getElementById('file-upload');
    const fileNameDisplay = document.getElementById('file-name-display');
    const dropZone = document.getElementById('file-drop-zone');
    const submitButton = form.querySelector('button[type="submit"]');

    const cardTitle = document.getElementById('card-title');
    const cardSubtitle = document.getElementById('card-subtitle');
    
    const formView = document.getElementById('form-view');
    const progressView = document.getElementById('progress-view');
    const resultView = document.getElementById('result-view');

    const progressFileName = document.getElementById('progress-filename');
    const progressPercent = document.getElementById('progress-percent');
    const progressBar = document.getElementById('progress-bar');
    const progressStatus = document.getElementById('progress-status');
    const progressEta = document.getElementById('progress-eta');

    let startTime;

    function switchView(view) {
        formView.classList.add('hidden');
        progressView.classList.add('hidden');
        resultView.classList.add('hidden');
        if (view === 'form') {
            formView.classList.remove('hidden');
            cardTitle.textContent = 'Share a File';
            cardSubtitle.textContent = 'Upload a file, get a secure link.';
        } else if (view === 'progress') {
            progressView.classList.remove('hidden');
            cardTitle.textContent = 'Uploading...';
        } else if (view === 'result') {
            resultView.classList.remove('hidden');
        }
    }

    function handleFileSelect(files) {
        if (files.length > 0) {
            const file = files[0];
            fileInput.files = files;
            fileNameDisplay.textContent = `${file.name} (${formatBytes(file.size)})`;
            console.log("File selected:", { name: file.name, size: file.size, type: file.type });
        }
    }

    fileInput.addEventListener('change', () => handleFileSelect(fileInput.files));
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleFileSelect(e.dataTransfer.files);
    });
    dropZone.addEventListener('click', () => fileInput.click());

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log("Form submitted.");
        const file = fileInput.files[0];
        const pin = document.getElementById('security_phrase').value;

        if (!file) {
            console.error("Upload submission failed: no file selected.");
            showError('Please select a file to upload.'); 
            return;
        }
        if (pin.length < 4) {
            console.error("Upload submission failed: PIN too short.");
            showError('Security phrase must be at least 4 characters.'); 
            return;
        }

        console.log(`Starting upload for file: ${file.name}, size: ${file.size} bytes.`);
        setFormDisabled(true);
        startTime = Date.now();
        switchView('progress');
        progressFileName.textContent = file.name;
        updateProgressUI(0, file.size, 'Initializing...');

        try {
            console.log("Requesting upload initiation from backend...");
            const initResponse = await fetch('/api/initiate-upload', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: file.name, file_size_bytes: file.size }),
            });

            if (!initResponse.ok) {
                const err = await initResponse.json();
                console.error("Backend failed to initiate upload:", err);
                throw new Error(err.error || 'Could not initiate upload.');
            }

            const result = await initResponse.json();
            console.log("Backend initiated upload successfully. Response:", result);
            
            // Always use direct upload
            console.log("Starting direct upload flow.");
            await directUpload(file, pin, result.par_url, result.object_name);

        } catch (error) {
            console.error("An error occurred during the upload process:", error);
            showError(error.message);
        }
    });

    function setFormDisabled(disabled) {
        submitButton.disabled = disabled;
        fileInput.disabled = disabled;
        document.getElementById('security_phrase').disabled = disabled;
    }

    function updateProgressUI(loaded, total, statusText) {
        const percent = total > 0 ? Math.round((loaded / total) * 100) : 0;
        progressBar.style.width = `${percent}%`;
        progressPercent.textContent = `${percent}%`;
        progressStatus.textContent = statusText;

        if (startTime && loaded > 0 && total > 0) {
            const elapsedTime = (Date.now() - startTime) / 1000;
            const uploadSpeed = loaded / elapsedTime;
            const remainingBytes = total - loaded;
            const etaSeconds = remainingBytes / uploadSpeed;

            if (isFinite(etaSeconds) && etaSeconds > 0) {
                progressEta.textContent = `ETA: ${formatTime(etaSeconds)}`;
            } else {
                progressEta.textContent = '';
            }
        } else {
            progressEta.textContent = '';
        }
    }

    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = Math.round(seconds % 60);
        if (minutes > 0) {
            return `${minutes}m ${remainingSeconds}s`;
        } else {
            return `${remainingSeconds}s`;
        }
    }

    async function directUpload(file, pin, parUrl, objectName) {
        console.log(`[Direct] Uploading to PAR URL for object: ${objectName}`);
        await uploadWithXHR(parUrl, file, (loaded, total) => {
            updateProgressUI(loaded, total, `Uploading... ${formatBytes(loaded)} / ${formatBytes(total)}`);
        });
        console.log("[Direct] Upload to storage complete.");
        await finalizeUpload(pin, file.name, objectName, file.size);
    }
    
    function uploadWithXHR(url, body, onProgress) {
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            xhr.open('PUT', url, true);
            console.log(`[XHR] PUT to ${url}`);
            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) onProgress(e.loaded, e.total);
            };
            xhr.onload = () => {
                console.log(`[XHR] onload. Status: ${xhr.status}`);
                if (xhr.status >= 200 && xhr.status < 300) {
                    console.log(`[XHR] Upload success.`);
                    resolve();
                } else {
                    const errorMsg = `Upload failed with status: ${xhr.status}`;
                    console.error('[XHR] Upload failed.', errorMsg);
                    reject(new Error(errorMsg));
                }
            };
            xhr.onerror = () => {
                console.error(`[XHR] Upload resulted in a network error.`);
                reject(new Error('A network error occurred during upload.'));
            };
            xhr.send(body);
        });
    }

    async function finalizeUpload(pin, original_filename, object_name, size_bytes) {
        console.log("Finalizing upload with backend...", { object_name, size_bytes });
        updateProgressUI(size_bytes, size_bytes, 'Finalizing...');
        
        const finalizeResponse = await fetch('/api/finalize-upload', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pin, original_filename, object_name, size_bytes }),
        });

        if (!finalizeResponse.ok) {
            const err = await finalizeResponse.json();
            console.error("Backend failed to finalize upload:", err);
            throw new Error(err.error || 'Could not finalize upload.');
        }

        const result = await finalizeResponse.json();
        console.log("Backend finalized successfully. Response:", result);
        showSuccess(result);
    }

    function showSuccess(data) {
        console.log("Displaying success view.");
        switchView('result');
        cardTitle.textContent = 'Link Created!';
        cardSubtitle.textContent = 'Your secure link is ready to be shared.';
        
        const encodedShareUrl = encodeURIComponent(data.share_url);
        const emailSubject = encodeURIComponent('ShareNest: File link');
        const emailBody = encodeURIComponent(`Here is your secure file link: ${data.share_url}`);

        resultView.innerHTML = `
            <div class="share-link-wrapper">
              <p>Your file <strong class="filename">${escapeHTML(data.filename)}</strong> is ready to be shared.</p>
              <div class="share-link-container">
                <label for="share-url-input">Share Link (expires in ${data.expiry_pretty})</label>
                <div class="share-link-input-wrapper">
                  <input id="share-url-input" type="text" value="${escapeHTML(data.share_url)}" readonly>
                  <button id="copy-btn" class="btn btn-secondary">Copy</button>
                </div>
              </div>

              <div class="share-options">
                <h4>Share via</h4>
                <div class="share-buttons">
                    <a href="mailto:?subject=${emailSubject}&body=${emailBody}" class="share-btn email" target="_blank">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M22 6C22 4.9 21.1 4 20 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6ZM20 6L12 11L4 6H20ZM20 18H4V8L12 13L20 8V18Z"></path></svg>
                        <span>Email</span>
                    </a>
                    <a href="https://wa.me/?text=${encodedShareUrl}" class="share-btn whatsapp" target="_blank">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12.04 2C6.58 2 2.13 6.45 2.13 11.91C2.13 13.66 2.59 15.35 3.43 16.84L2.05 21.83L7.24 20.47C8.68 21.24 10.33 21.7 12.04 21.7C17.5 21.7 21.95 17.25 21.95 11.79C21.95 6.33 17.5 2 12.04 2ZM12.04 3.62C16.56 3.62 20.33 7.32 20.33 11.79C20.33 16.26 16.56 19.96 12.04 19.96C10.51 19.96 9.05 19.56 7.78 18.81L7.53 18.67L4.35 19.51L5.21 16.41L5.05 16.15C4.21 14.78 3.75 13.19 3.75 11.79C3.75 7.32 7.52 3.62 12.04 3.62ZM9.01 7.29C8.83 7.29 8.6 7.37 8.41 7.74C8.22 8.11 7.63 9.14 7.63 10.3C7.63 11.45 8.44 12.52 8.61 12.72C8.78 12.92 10.03 14.94 11.96 15.7C13.64 16.36 14.07 16.14 14.41 16.1C14.75 16.06 15.65 15.54 15.86 15.02C16.07 14.5 16.07 14.07 16.03 13.97C15.98 13.87 15.81 13.82 15.56 13.7C15.31 13.58 14.2 13.06 13.98 12.96C13.76 12.86 13.62 12.81 13.48 13.01C13.34 13.21 12.93 13.7 12.79 13.85C12.65 14 12.51 14.03 12.26 13.91C12.01 13.79 11.08 13.48 9.92 12.48C9.02 11.73 8.44 10.82 8.29 10.57C8.14 10.32 8.25 10.19 8.37 10.07C8.48 9.95 8.61 9.78 8.73 9.63C8.85 9.48 8.9 9.38 9 9.28C9.1 9.18 9.06 9.04 9.01 8.94C8.96 8.84 8.53 7.82 8.36 7.45C8.19 7.08 8.04 7.15 7.86 7.15L7.86 7.15L9.01 7.29Z"></path></svg>
                        <span>WhatsApp</span>
                    </a>
                </div>
              </div>

              <button id="reset-button" class="btn btn-primary">Share Another File</button>
            </div>`;
        
        document.getElementById('copy-btn').addEventListener('click', (e) => {
            navigator.clipboard.writeText(data.share_url);
            e.target.textContent = 'Copied!';
            setTimeout(() => { e.target.textContent = 'Copy'; }, 2000);
        });
        document.getElementById('reset-button').addEventListener('click', resetToForm);
    }

    function showError(message) {
        console.error("Displaying error view:", message);
        switchView('result');
        cardTitle.textContent = 'Upload Error';
        cardSubtitle.textContent = ''; // No subtitle for errors
        resultView.innerHTML = `
            <div class="error-message">
              <h3>Upload Error</h3>
              <p>${escapeHTML(message)}</p>
            </div>
            <button id="reset-button" class="btn btn-primary">Try Again</button>`;
        document.getElementById('reset-button').addEventListener('click', resetToForm);
    }
    
    function resetToForm() {
        console.log("Resetting form.");
        form.reset();
        fileNameDisplay.textContent = 'Drop a file here or click to select';
        setFormDisabled(false);
        switchView('form');
    }

    function formatBytes(bytes, decimals = 2) {
        if (!+bytes) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
    }

    function escapeHTML(str) {
        return str.replace(/[&<>"']/g, match => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match]));
    }
    
    function copyToClipboard(text, message) {
        navigator.clipboard.writeText(text).then(() => {
            console.log(message);
        }).catch(err => {
            console.error('Failed to copy text: ', err);
        });
    }
});
</script>
{% endblock %}