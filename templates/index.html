{% extends "layout.html" %}
{% block content %}
<div class="flex flex-col items-center justify-center min-h-screen px-4 py-8 text-dark-text bg-light-bg sm:px-6 lg:px-8">
  <div class="w-full max-w-md">
    <div id="upload-card" class="bg-white rounded-2xl shadow-xl transition-all duration-300 overflow-hidden">
      <div class="p-6 border-b border-gray-200">
        <h2 id="card-title" class="text-2xl font-bold text-dark-text text-center">Share a File</h2>
        <p id="card-subtitle" class="mt-1 text-sm text-gray-500 text-center">Upload a file, get a secure link.</p>
      </div>

      <div id="card-body" class="p-6">
        <!-- Upload Form -->
        <div id="form-view">
          <form id="upload-form" class="space-y-6">
            <div>
              <div id="file-drop-zone" class="relative mt-1 flex flex-col items-center justify-center px-6 pt-10 pb-10 border-2 border-gray-300 border-dashed rounded-md hover:border-primary-base transition-colors cursor-pointer">
                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                <div class="flex text-sm text-gray-600 mt-2">
                  <label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-primary-base hover:text-primary-dark focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-primary-base">
                    <span>Upload a file</span>
                  </label>
                  <p class="pl-1">or drag and drop</p>
                </div>
                <p id="file-name-display" class="text-sm text-dark-text font-medium mt-2"></p>
                <input id="file-upload" name="file" type="file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" required>
              </div>
            </div>
            <div>
              <label for="security_phrase" class="block text-sm font-medium text-gray-700">Security Phrase</label>
              <input type="password" name="security_phrase" id="security_phrase" minlength="4" required placeholder="At least 4 characters" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-base sm:text-sm">
            </div>
            <div>
              <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-primary-base hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-base disabled:bg-gray-400 disabled:cursor-not-allowed">
                Upload & Create Link
              </button>
            </div>
          </form>
        </div>

        <!-- Upload Progress -->
        <div id="progress-view" class="hidden">
            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <span id="progress-filename" class="text-base font-medium text-dark-text truncate"></span>
                    <span id="progress-percent" class="text-base font-medium text-gray-700">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-primary-base h-2.5 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-sm text-gray-600">
                    <span id="progress-size"></span>
                    <span id="progress-eta"></span>
                </div>
            </div>
        </div>

        <!-- Upload Result -->
        <div id="result-view" class="hidden"></div>
      </div>
    </div>
    <p class="mt-4 text-xs text-center text-gray-500">End-to-end encrypted file sharing.</p>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('upload-form');
    const fileInput = document.getElementById('file-upload');
    const fileNameDisplay = document.getElementById('file-name-display');
    const dropZone = document.getElementById('file-drop-zone');
    const submitButton = form.querySelector('button[type="submit"]');

    const cardTitle = document.getElementById('card-title');
    const cardSubtitle = document.getElementById('card-subtitle');
    
    const formView = document.getElementById('form-view');
    const progressView = document.getElementById('progress-view');
    const resultView = document.getElementById('result-view');

    const progressFileName = document.getElementById('progress-filename');
    const progressPercent = document.getElementById('progress-percent');
    const progressBar = document.getElementById('progress-bar');
    const progressEta = document.getElementById('progress-eta');
    const progressSize = document.getElementById('progress-size');

    let uploadStartTime;

    function switchView(view) {
        formView.classList.add('hidden');
        progressView.classList.add('hidden');
        resultView.classList.add('hidden');
        if (view === 'form') {
            formView.classList.remove('hidden');
            cardTitle.textContent = 'Share a File';
            cardSubtitle.textContent = 'Upload a file, get a secure link.';
        } else if (view === 'progress') {
            progressView.classList.remove('hidden');
            cardTitle.textContent = 'Uploading...';
        } else if (view === 'result') {
            resultView.classList.remove('hidden');
            cardTitle.textContent = 'File Shared';
            cardSubtitle.textContent = 'Your secure link is ready.';
        }
    }

    function handleFileSelect(files) {
        if (files.length > 0) {
            const file = files[0];
            fileInput.files = files;
            fileNameDisplay.textContent = `${file.name} (${formatBytes(file.size)})`;
        }
    }

    fileInput.addEventListener('change', () => handleFileSelect(fileInput.files));
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-primary-base'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('border-primary-base'));
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-primary-base');
        handleFileSelect(e.dataTransfer.files);
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const file = fileInput.files[0];
        const pin = document.getElementById('security_phrase').value;

        if (!file) { showError('Please select a file to upload.'); return; }
        if (pin.length < 4) { showError('Security phrase must be at least 4 characters.'); return; }

        setFormDisabled(true);
        switchView('progress');
        cardSubtitle.textContent = `Uploading ${file.name}...`;
        updateProgressUI(0, 0, file.size);

        try {
            const initResponse = await fetch('/api/initiate-upload', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: file.name, filesize: file.size }),
            });

            if (!initResponse.ok) {
                const err = await initResponse.json();
                throw new Error(err.error || 'Could not initiate upload.');
            }

            const { par_url, object_name } = await initResponse.json();
            uploadStartTime = Date.now();
            await directUpload(file, pin, par_url, object_name);
        } catch (error) {
            showError(error.message);
        }
    });

    function setFormDisabled(disabled) {
        submitButton.disabled = disabled;
        fileInput.disabled = disabled;
        document.getElementById('security_phrase').disabled = disabled;
    }

    function updateProgressUI(loaded, total) {
        const percent = total > 0 ? Math.round((loaded / total) * 100) : 0;
        progressBar.style.width = `${percent}%`;
        progressPercent.textContent = `${percent}%`;
        progressSize.textContent = `${formatBytes(loaded)} / ${formatBytes(total)}`;

        const elapsed = (Date.now() - uploadStartTime) / 1000;
        if (elapsed > 0 && loaded > 0 && loaded < total) {
            const bps = loaded / elapsed;
            const remainingBytes = total - loaded;
            const remainingSeconds = Math.round(remainingBytes / bps);
            progressEta.textContent = `ETA: ${formatTime(remainingSeconds)}`;
        } else {
            progressEta.textContent = '';
        }
    }

    async function directUpload(file, pin, parUrl, objectName) {
        try {
            await new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('PUT', parUrl, true);
                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) updateProgressUI(e.loaded, e.total);
                };
                xhr.onload = () => {
                    if (xhr.status >= 200 && xhr.status < 300) resolve();
                    else reject(new Error('Upload to storage failed. Please try again.') );
                };
                xhr.onerror = () => reject(new Error('A network error occurred.'));
                xhr.send(file);
            });

            cardSubtitle.textContent = 'Finalizing upload...';
            const finalizeResponse = await fetch('/api/finalize-upload', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    pin: pin,
                    original_filename: file.name,
                    object_name: objectName,
                    size_bytes: file.size,
                }),
            });

            if (!finalizeResponse.ok) {
                const err = await finalizeResponse.json();
                throw new Error(err.error || 'Could not finalize upload.');
            }

            const result = await finalizeResponse.json();
            showSuccess(result);
        } catch (error) {
            showError(error.message);
        }
    }

    function showSuccess(data) {
        switchView('result');
        resultView.innerHTML = `
            <div class="space-y-4">
              <p class="text-sm text-gray-600">Your file <strong class="font-medium text-dark-text">${escapeHTML(data.filename)}</strong> is ready to be shared.</p>
              <div class="p-3 bg-gray-50 rounded-lg">
                <label for="shareLink" class="block text-xs font-medium text-gray-500">Share Link (expires in ${data.expiry_pretty})</label>
                <div class="mt-1 flex rounded-md shadow-sm">
                  <input id="shareLink" type="text" class="flex-1 block w-full rounded-none rounded-l-md px-3 py-2 border-gray-300 bg-gray-100 text-gray-700 sm:text-sm" value="${escapeHTML(data.share_url)}" readonly>
                  <button id="copy-button" class="inline-flex items-center px-4 py-2 border border-l-0 border-gray-300 rounded-r-md bg-gray-200 text-sm font-medium text-gray-700 hover:bg-gray-300">
                    <span id="copy-text">Copy</span>
                  </button>
                </div>
              </div>
              <button id="reset-button" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-base hover:bg-primary-dark">Share Another File</button>
            </div>`;
        
        document.getElementById('copy-button').addEventListener('click', () => {
            navigator.clipboard.writeText(data.share_url);
            document.getElementById('copy-text').textContent = 'Copied!';
            setTimeout(() => { document.getElementById('copy-text').textContent = 'Copy'; }, 2000);
        });
        document.getElementById('reset-button').addEventListener('click', resetToForm);
    }

    function showError(message) {
        switchView('result');
        resultView.innerHTML = `
            <div class="rounded-md bg-red-50 p-4">
              <div class="flex">
                <div class="ml-3">
                  <h3 class="text-sm font-medium text-red-800">Upload Error</h3>
                  <p class="mt-2 text-sm text-red-700">${escapeHTML(message)}</p>
                </div>
              </div>
            </div>
            <button id="reset-button" class="mt-4 w-full flex justify-center py-2 px-4 border rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">Try Again</button>`;
        document.getElementById('reset-button').addEventListener('click', resetToForm);
    }
    
    function resetToForm() {
        form.reset();
        fileNameDisplay.textContent = '';
        setFormDisabled(false);
        switchView('form');
    }

    // --- Utils ---
    function formatBytes(bytes, decimals = 2) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    function formatTime(seconds) {
        if (seconds < 60) return `${Math.round(seconds)}s`;
        const minutes = Math.floor(seconds / 60);
        return `${minutes}m ${Math.round(seconds % 60)}s`;
    }

    function escapeHTML(str) {
        return str.replace(/[&<>"']/g, (match) => {
            return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match];
        });
    }
});
</script>
{% endblock %}