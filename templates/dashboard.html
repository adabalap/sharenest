{% extends "layout.html" %}

{% block title %}User Dashboard{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
<style>
    .file-card {
        word-wrap: break-word;
    }
    .share-icons a {
        color: #6c757d;
        font-size: 1.5rem;
        margin-right: 10px;
    }
    .card-footer {
        background-color: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">My Files</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% if files %}
    <div class="row">
        {% for file in files %}
        <div class="col-md-6 col-lg-4 mb-4">
                <div class="card file-card h-100" id="file-card-{{ file.id }}">
                    <div class="card-header d-flex justify-content-between align-items-center" id="heading-{{ file.id }}">
                        <h5 class="mb-0 flex-grow-1">
                            <button class="btn btn-link text-decoration-none text-start text-dark w-100 py-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ file.id }}" aria-expanded="false" aria-controls="collapse-{{ file.id }}">
                                {{ file.original_filename }}
                            </button>
                        </h5>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-sm btn-secondary view-mode me-2" onclick="toggleEdit({{ file.id }}, true)" title="Edit">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteFile({{ file.id }})" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>

                    <div id="collapse-{{ file.id }}" class="collapse" aria-labelledby="heading-{{ file.id }}" data-bs-parent="#file-card-{{ file.id }}">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-12 col-md-6 mb-3">
                                    <label class="form-label text-muted small mb-1">Sharing Message</label>
                                    <p class="view-mode card-text mb-0">{{ file.sharing_message or 'N/A' }}</p>
                                    <div class="input-group edit-mode d-none">
                                        <input type="text" class="form-control" id="message-{{ file.id }}" value="{{ file.sharing_message or '' }}">
                                    </div>
                                </div>

                                <div class="col-12 col-md-6 mb-3">
                                    <label class="form-label text-muted small mb-1">Download Link</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" value="{{ request.host_url }}share/{{ file.token }}" readonly>
                                        <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('{{ request.host_url }}share/{{ file.token }}')" title="Copy to clipboard"><i class="bi bi-clipboard"></i></button>
                                    </div>
                                    <div class="share-icons mt-2">
                                        <a href="https://wa.me/?text=Check%20out%20this%20file:%20{{ request.host_url }}share/{{ file.token }}" target="_blank" title="Share on WhatsApp"><i class="bi bi-whatsapp"></i></a>
                                        <a href="mailto:?subject=File%20Shared&body=Check%20out%20this%20file:%20{{ request.host_url }}share/{{ file.token }}" title="Share via Email"><i class="bi bi-envelope"></i></a>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-12 col-md-6 mb-3">
                                    <label class="form-label text-muted small mb-1">Downloads</label>
                                    <p class="card-text view-mode mb-0">{{ file.download_count }} / <span class="max-downloads-text">{{ file.max_downloads }}</span></p>
                                    <div class="input-group edit-mode d-none">
                                        <input type="number" class="form-control" id="downloads-{{ file.id }}" value="{{ file.max_downloads }}">
                                    </div>
                                </div>

                                <div class="col-12 col-md-6 mb-3">
                                    <label class="form-label text-muted small mb-1">Created</label>
                                    <p class="card-text mb-0">{{ file.created_at.strftime('%Y-%m-%d') }}</p>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-12 col-md-6 mb-3">
                                    <label class="form-label text-muted small mb-1">Expires</label>
                                    <p class="view-mode card-text mb-0">{{ file.expiry_date.strftime('%Y-%m-%d') }}</p>
                                    <div class="input-group edit-mode d-none">
                                        <input type="date" class="form-control" id="expires-{{ file.id }}" value="{{ file.expiry_date.strftime('%Y-%m-%d') }}">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer text-end edit-mode d-none">
                            <button class="btn btn-sm btn-success me-2" onclick="saveChanges({{ file.id }})" title="Save Changes">
                                <i class="bi bi-save"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="toggleEdit({{ file.id }}, false)" title="Cancel Edit">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </div>
                    </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center">
        <i class="bi bi-cloud-upload" style="font-size: 3rem;"></i>
        <p class="mt-3">You haven't uploaded any files yet.</p>
        <a href="{{ url_for('home') }}" class="btn btn-primary">Upload Now</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showToast('Share link copied to clipboard!');
        }, (err) => {
            console.error('Could not copy text: ', err);
            showToast('Failed to copy link.', 'error');
        });
    }

    function toggleEdit(fileId, isEditMode) {
        const card = document.getElementById(`file-card-${fileId}`);
        const collapseElement = document.getElementById(`collapse-${fileId}`);

        // If not already expanded, expand the collapse section
        if (isEditMode && !collapseElement.classList.contains('show')) {
            const bsCollapse = new bootstrap.Collapse(collapseElement, { toggle: false });
            bsCollapse.show();
        }

        // Toggle visibility of view-mode and edit-mode elements within the collapsed section
        collapseElement.querySelectorAll('.view-mode').forEach(el => el.classList.toggle('d-none', isEditMode));
        collapseElement.querySelectorAll('.edit-mode').forEach(el => el.classList.toggle('d-none', !isEditMode));

        // Toggle visibility of the card-footer (save/cancel buttons)
        card.querySelector('.card-footer').classList.toggle('d-none', !isEditMode);

        // Toggle visibility of the 'Edit' button in the header
        card.querySelector('.btn-secondary.view-mode').classList.toggle('d-none', isEditMode);
    }

    async function saveChanges(fileId) {
        const message = document.getElementById(`message-${fileId}`).value;
        const max_downloads = document.getElementById(`downloads-${fileId}`).value;
        const expiry_date = document.getElementById(`expires-${fileId}`).value;

        try {
            const responses = await Promise.all([
                fetch(`/api/file/${fileId}/message`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message })
                }),
                fetch(`/api/file/${fileId}/downloads`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ max_downloads: max_downloads })
                }),
                fetch(`/api/file/${fileId}/expiry`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ expiry_date: expiry_date })
                })
            ]);

            const results = await Promise.all(responses.map(res => res.json()));
            
            let allSuccess = true;
            results.forEach((result, i) => {
                if (!responses[i].ok) {
                    allSuccess = false;
                    showToast(result.error || 'An unknown error occurred.', 'error');
                }
            });

            if (allSuccess) {
                showToast('File details updated successfully!');
                // Update UI without reloading
                const card = document.getElementById(`file-card-${fileId}`);
                // Update the view-mode elements directly
                card.querySelector(`#collapse-${fileId} p.view-mode`).textContent = message || 'N/A'; // Update message
                card.querySelector(`#collapse-${fileId} .max-downloads-text`).textContent = max_downloads; // Update max downloads
                card.querySelector(`#collapse-${fileId} p.view-mode:nth-of-type(2)`).textContent = expiry_date; // Update expiry

                toggleEdit(fileId, false); // Exit edit mode
            }

        } catch (error) {
            console.error('Error saving changes:', error);
            showToast('An unexpected error occurred while saving.', 'error');
        }
    }

    async function deleteFile(fileId) {
        if (!confirm('Are you sure you want to delete this file? This action cannot be undone.')) {
            return;
        }
        try {
            const response = await fetch(`/api/file/${fileId}`, { method: 'DELETE' });
            const result = await response.json();
            if (response.ok && result.success) {
                showToast('File deleted successfully.');
                document.getElementById(`file-card-${fileId}`).parentElement.remove();
            } else {
                showToast(result.error || 'Failed to delete file.', 'error');
            }
        } catch (error) {
            console.error('Error deleting file:', error);
            showToast('An error occurred while deleting the file.', 'error');
        }
    }

    function showToast(message, type = 'success') {
        const toastContainer = document.createElement('div');
        toastContainer.className = `toast align-items-center text-white bg-${type} border-0 position-fixed top-0 end-0 m-3`;
        toastContainer.role = 'alert';
        toastContainer.ariaLive = 'assertive';
        toastContainer.ariaAtomic = 'true';
        toastContainer.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        document.body.appendChild(toastContainer);
        const toast = new bootstrap.Toast(toastContainer, { delay: 3000 });
        toast.show();
        toastContainer.addEventListener('hidden.bs.toast', () => toastContainer.remove());
    }
</script>
{% endblock %}